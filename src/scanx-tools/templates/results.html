<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results - {{ job.filename }} | ScanX Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .glass {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .highlight-box {
            position: absolute;
            border: 2px solid #ec4899;
            background: rgba(236, 72, 153, 0.2);
            pointer-events: none;
            transition: all 0.2s;
        }
        .data-row:hover {
            background: rgba(236, 72, 153, 0.1);
        }
        .data-row.active {
            background: rgba(236, 72, 153, 0.2);
            border-left: 3px solid #ec4899;
        }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen">
    <!-- Header -->
    <header class="glass sticky top-0 z-50 border-b border-slate-800">
        <div class="max-w-full mx-auto px-6 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="/" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-xl transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </a>
                    <div>
                        <h1 class="text-lg font-semibold text-white truncate max-w-lg" title="{{ job.filename }}">{{ job.filename }}</h1>
                        <p class="text-xs text-slate-400">{{ job.pages }} pages • Processed {{ job.completed_at }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="exportData()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-xl text-sm transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex" style="height: calc(100vh - 65px);">
        <!-- Left: PDF Viewer -->
        <div class="w-1/2 border-r border-slate-800 flex flex-col">
            <div class="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900/50">
                <div class="flex items-center gap-2">
                    <button onclick="prevPage()" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <span class="text-sm text-slate-300">
                        Page <span id="currentPage">1</span> / <span id="totalPages">{{ job.pages }}</span>
                    </span>
                    <button onclick="nextPage()" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="zoomOut()" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors">−</button>
                    <span id="zoomLevel" class="text-sm text-slate-400 w-12 text-center">100%</span>
                    <button onclick="zoomIn()" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors">+</button>
                </div>
            </div>
            <div id="pdfContainer" class="flex-1 overflow-auto bg-slate-900 p-4 flex items-start justify-center">
                <div id="pdfViewer" class="relative bg-white shadow-2xl">
                    <canvas id="pdfCanvas"></canvas>
                    <div id="highlightLayer"></div>
                </div>
            </div>
        </div>

        <!-- Right: Data Panel -->
        <div class="w-1/2 flex flex-col">
            <!-- Tabs -->
            <div class="p-3 border-b border-slate-800 flex items-center gap-2 bg-slate-900/50">
                <button onclick="showDataTab('extracted')" class="data-tab px-4 py-2 bg-pink-600 rounded-lg text-sm transition-colors" data-tab="extracted">Extracted Data</button>
                <button onclick="showDataTab('pages')" class="data-tab px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors" data-tab="pages">Page Details</button>
                <button onclick="showDataTab('raw')" class="data-tab px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors" data-tab="raw">Raw JSON</button>
            </div>

            <!-- Data Content -->
            <div id="dataContent" class="flex-1 overflow-auto p-4">
                <div class="text-center py-12 text-slate-500">Loading...</div>
            </div>
        </div>
    </div>

    <script>
    const JOB_ID = '{{ job.id }}';
    let pdfDoc = null;
    let currentPage = 1;
    let zoomScale = 1.0;
    let resultsData = null;
    
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        await loadPdf();
        await loadResults();
    });

    async function loadPdf() {
        try {
            const url = `/api/jobs/${JOB_ID}/pdf`;
            pdfDoc = await pdfjsLib.getDocument(url).promise;
            document.getElementById('totalPages').textContent = pdfDoc.numPages;
            renderPage(1);
        } catch (e) {
            console.error('Error loading PDF:', e);
        }
    }

    async function renderPage(num) {
        if (!pdfDoc) return;
        currentPage = num;
        document.getElementById('currentPage').textContent = num;
        
        const page = await pdfDoc.getPage(num);
        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');
        
        const viewport = page.getViewport({ scale: zoomScale * 1.5 });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        
        await page.render({ canvasContext: ctx, viewport }).promise;
    }

    function prevPage() {
        if (currentPage > 1) renderPage(currentPage - 1);
    }

    function nextPage() {
        if (pdfDoc && currentPage < pdfDoc.numPages) renderPage(currentPage + 1);
    }

    function zoomIn() {
        zoomScale = Math.min(zoomScale + 0.25, 3);
        document.getElementById('zoomLevel').textContent = Math.round(zoomScale * 100) + '%';
        renderPage(currentPage);
    }

    function zoomOut() {
        zoomScale = Math.max(zoomScale - 0.25, 0.5);
        document.getElementById('zoomLevel').textContent = Math.round(zoomScale * 100) + '%';
        renderPage(currentPage);
    }

    async function loadResults() {
        try {
            const response = await fetch(`/api/jobs/${JOB_ID}/results`);
            resultsData = await response.json();
            renderExtractedData();
        } catch (e) {
            console.error('Error loading results:', e);
            document.getElementById('dataContent').innerHTML = `
                <div class="text-center py-12 text-red-400">Error loading results</div>
            `;
        }
    }

    function renderExtractedData() {
        const container = document.getElementById('dataContent');
        
        if (!resultsData?.success) {
            container.innerHTML = `<div class="text-center py-12 text-slate-500">No data available</div>`;
            return;
        }
        
        const data = resultsData.matched_data || resultsData.ocr_data;
        if (!data) {
            container.innerHTML = `<div class="text-center py-12 text-slate-500">No extracted data</div>`;
            return;
        }
        
        // Render structured data
        let html = '<div class="space-y-4">';
        
        // Document info
        if (data._metadata) {
            html += `
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <h3 class="font-semibold text-pink-400 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Document Info
                    </h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        ${Object.entries(data._metadata).map(([key, value]) => `
                            <div class="data-row p-2 rounded-lg cursor-pointer" onclick="highlightField('${key}')">
                                <div class="text-slate-400 text-xs">${key}</div>
                                <div class="text-white">${value || '-'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Pages summary
        if (data.pages) {
            html += `
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <h3 class="font-semibold text-pink-400 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        Pages (${data.pages.length})
                    </h3>
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        ${data.pages.map((page, i) => `
                            <div class="data-row p-3 rounded-lg cursor-pointer hover:bg-slate-700/50 transition-colors flex items-center gap-3" onclick="goToPage(${i + 1})">
                                <div class="w-8 h-8 bg-pink-500/20 rounded-lg flex items-center justify-center text-pink-400 text-sm font-bold">${i + 1}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm text-white">${page.page_type || page.matched_template || 'Unknown'}</div>
                                    <div class="text-xs text-slate-400 truncate">${(page.content || page.text || '').substring(0, 80)}...</div>
                                </div>
                                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        container.innerHTML = html;
    }

    function renderPageDetails() {
        const container = document.getElementById('dataContent');
        const data = resultsData?.matched_data || resultsData?.ocr_data;
        
        if (!data?.pages) {
            container.innerHTML = `<div class="text-center py-12 text-slate-500">No page data</div>`;
            return;
        }
        
        const page = data.pages[currentPage - 1];
        if (!page) {
            container.innerHTML = `<div class="text-center py-12 text-slate-500">Page not found</div>`;
            return;
        }
        
        container.innerHTML = `
            <div class="space-y-4">
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <h3 class="font-semibold text-pink-400 mb-3">Page ${currentPage} Details</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="text-xs text-slate-400 mb-1">Page Type</div>
                            <div class="text-white">${page.page_type || page.matched_template || 'Unknown'}</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400 mb-1">Content</div>
                            <div class="text-white text-sm bg-slate-900/50 p-3 rounded-lg max-h-64 overflow-y-auto whitespace-pre-wrap">${page.content || page.text || 'No content'}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderRawJson() {
        const container = document.getElementById('dataContent');
        const data = resultsData?.matched_data || resultsData?.ocr_data;
        
        container.innerHTML = `
            <div class="bg-slate-900/50 rounded-xl p-4">
                <pre class="text-xs text-slate-300 overflow-auto max-h-[600px] whitespace-pre-wrap">${JSON.stringify(data, null, 2)}</pre>
            </div>
        `;
    }

    function showDataTab(tab) {
        document.querySelectorAll('.data-tab').forEach(btn => {
            btn.className = btn.dataset.tab === tab
                ? 'data-tab px-4 py-2 bg-pink-600 rounded-lg text-sm transition-colors'
                : 'data-tab px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors';
        });
        
        if (tab === 'extracted') renderExtractedData();
        else if (tab === 'pages') renderPageDetails();
        else if (tab === 'raw') renderRawJson();
    }

    function goToPage(pageNum) {
        renderPage(pageNum);
        if (document.querySelector('.data-tab[data-tab="pages"]').classList.contains('bg-pink-600')) {
            renderPageDetails();
        }
    }

    function highlightField(field) {
        // TODO: Highlight field location on PDF
        console.log('Highlight field:', field);
    }

    function exportData() {
        const data = resultsData?.matched_data || resultsData?.ocr_data;
        if (!data) return;
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${JOB_ID}_results.json`;
        a.click();
        URL.revokeObjectURL(url);
    }
    </script>
</body>
</html>

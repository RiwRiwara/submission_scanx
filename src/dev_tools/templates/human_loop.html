{% extends "base.html" %}
{% block title %}Human-in-the-Loop - Page Ignore{% endblock %}
{% block nav_human_loop %}bg-slate-700 text-pink-400{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-pink-400">Human-in-the-Loop</h1>
            <p class="text-slate-400 text-sm">Configure pages to ignore during OCR to reduce costs</p>
        </div>
        <div class="flex gap-2">
            <button onclick="saveAllChanges()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-medium">
                üíæ Save All Changes
            </button>
            <button onclick="refreshList()" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg">
                üîÑ Refresh
            </button>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="grid grid-cols-4 gap-4">
        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
            <div class="text-2xl font-bold text-cyan-400" id="totalPdfs">-</div>
            <div class="text-slate-400 text-sm">Total PDFs</div>
        </div>
        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
            <div class="text-2xl font-bold text-green-400" id="configuredPdfs">-</div>
            <div class="text-slate-400 text-sm">Configured</div>
        </div>
        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
            <div class="text-2xl font-bold text-yellow-400" id="totalIgnoredPages">-</div>
            <div class="text-slate-400 text-sm">Pages Ignored</div>
        </div>
        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
            <div class="text-2xl font-bold text-pink-400" id="estimatedSavings">-</div>
            <div class="text-slate-400 text-sm">Est. Cost Savings</div>
        </div>
    </div>

    <!-- Main Content - 2 column layout -->
    <div class="grid grid-cols-4 gap-4" style="height: calc(100vh - 280px);">
        <!-- PDF List (narrower) -->
        <div class="bg-slate-800 rounded-xl border border-slate-700 flex flex-col">
            <div class="p-3 border-b border-slate-700">
                <input type="text" id="searchPdf" placeholder="Search PDFs..." 
                       class="w-full px-3 py-2 bg-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500"
                       oninput="filterPdfs()">
            </div>
            <div class="flex-1 overflow-y-auto p-2" id="pdfList">
                <div class="text-slate-500 text-center py-8">Loading...</div>
            </div>
        </div>

        <!-- PDF Pages Viewer (wider - 3 columns) -->
        <div class="col-span-3 bg-slate-800 rounded-xl border border-slate-700 flex flex-col">
            <!-- Header with controls -->
            <div class="p-3 border-b border-slate-700 flex justify-between items-center flex-wrap gap-2">
                <div class="flex items-center gap-3">
                    <span class="font-medium text-pink-400" id="viewerTitle">Select a PDF</span>
                    <span class="text-sm text-slate-400" id="pageCountInfo"></span>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <div class="flex gap-1">
                        <button onclick="selectAllPages()" class="px-2 py-1 bg-red-600 hover:bg-red-500 rounded text-xs">üö´ Ignore All</button>
                        <button onclick="deselectAllPages()" class="px-2 py-1 bg-green-600 hover:bg-green-500 rounded text-xs">‚úÖ Keep All</button>
                        <button onclick="invertSelection()" class="px-2 py-1 bg-slate-600 hover:bg-slate-500 rounded text-xs">üîÑ Invert</button>
                    </div>
                    <span class="text-slate-600">|</span>
                    <!-- Column selector -->
                    <div class="flex gap-1 items-center">
                        <span class="text-xs text-slate-400">Cols:</span>
                        <button onclick="setColumns(1)" id="col-1" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs">1</button>
                        <button onclick="setColumns(2)" id="col-2" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs">2</button>
                        <button onclick="setColumns(3)" id="col-3" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs">3</button>
                        <button onclick="setColumns(4)" id="col-4" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs">4</button>
                        <button onclick="setColumns(5)" id="col-5" class="px-2 py-1 bg-pink-600 rounded text-xs">5</button>
                        <button onclick="setColumns(6)" id="col-6" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs">6</button>
                    </div>
                    <span class="text-slate-600">|</span>
                    <!-- Zoom -->
                    <div class="flex gap-1 items-center">
                        <span class="text-xs text-slate-400">Size:</span>
                        <button onclick="zoomOut()" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs">‚àí</button>
                        <span id="zoomLevel" class="text-xs text-slate-400 w-10 text-center">50%</span>
                        <button onclick="zoomIn()" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs">+</button>
                    </div>
                </div>
            </div>
            
            <!-- All Pages Grid - Scrollable -->
            <div class="flex-1 overflow-y-auto p-4 bg-slate-900" id="pdfPagesContainer">
                <div class="text-slate-500 text-center py-20">
                    <div class="text-6xl mb-4">üìÑ</div>
                    <div class="text-lg">Select a PDF from the list</div>
                    <div class="text-sm mt-2">Click on any page to toggle ignore/keep</div>
                </div>
            </div>
            
            <!-- Footer with legend and notes -->
            <div class="p-3 border-t border-slate-700 flex items-center gap-4">
                <div class="flex items-center gap-4 text-sm">
                    <span class="flex items-center gap-1">
                        <span class="w-4 h-4 bg-green-600 rounded border-2 border-green-400"></span> Keep (OCR)
                    </span>
                    <span class="flex items-center gap-1">
                        <span class="w-4 h-4 bg-red-600 rounded border-2 border-red-400"></span> Ignore (Skip)
                    </span>
                    <span class="text-slate-500">| Click page to toggle</span>
                </div>
                <div class="flex-1">
                    <input type="text" id="notesInput" placeholder="Notes (optional)..." 
                           class="w-full px-3 py-1 bg-slate-700 rounded text-sm focus:outline-none focus:ring-2 focus:ring-pink-500">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PDF.js for rendering -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
{% endblock %}

{% block scripts %}
<script>
// State
let allPdfs = [];
let selectedPdf = null;
let pdfDoc = null;
let zoomScale = 0.5; // Balance between size and clarity
let columnCount = 5; // Default columns
let pendingChanges = {};
let renderedCanvases = {}; // Cache rendered pages

// Initialize PDF.js
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

async function loadPdfList() {
    const mode = getMode();
    try {
        const data = await fetchApi(`/api/human-loop/pdfs?mode=${mode}`);
        allPdfs = data.pdfs || [];
        renderPdfList();
        updateStats();
    } catch (e) {
        console.error('Error loading PDFs:', e);
    }
}

function renderPdfList() {
    const search = document.getElementById('searchPdf').value.toLowerCase();
    const filtered = allPdfs.filter(p => p.name.toLowerCase().includes(search));
    
    const container = document.getElementById('pdfList');
    if (filtered.length === 0) {
        container.innerHTML = '<div class="text-slate-500 text-center py-8">No PDFs found</div>';
        return;
    }
    
    container.innerHTML = filtered.map(pdf => {
        const ignoreCount = (pendingChanges[pdf.name]?.ignore_pages || pdf.ignore_pages || []).length;
        const hasChanges = pendingChanges[pdf.name] !== undefined;
        const isSelected = selectedPdf?.name === pdf.name;
        
        return `
            <div class="p-2 rounded-lg cursor-pointer mb-1 ${isSelected ? 'bg-pink-600' : 'bg-slate-700 hover:bg-slate-600'} ${hasChanges ? 'ring-2 ring-yellow-500' : ''}"
                 onclick="selectPdf('${pdf.name.replace(/'/g, "\\'")}')">
                <div class="font-medium text-xs truncate" title="${pdf.name}">${pdf.name.substring(0, 30)}...</div>
                <div class="flex gap-1 mt-1 text-xs">
                    <span class="bg-slate-600 px-1 py-0.5 rounded text-[10px]">${pdf.total_pages || '?'}p</span>
                    ${ignoreCount > 0 ? `<span class="bg-red-600 px-1 py-0.5 rounded text-[10px]">${ignoreCount} ign</span>` : ''}
                    ${hasChanges ? '<span class="bg-yellow-600 px-1 py-0.5 rounded text-[10px]">*</span>' : ''}
                </div>
            </div>
        `;
    }).join('');
}

function filterPdfs() {
    renderPdfList();
}

function updateStats() {
    document.getElementById('totalPdfs').textContent = allPdfs.length;
    document.getElementById('configuredPdfs').textContent = allPdfs.filter(p => p.has_config).length;
    
    let totalIgnored = 0;
    allPdfs.forEach(pdf => {
        const ignorePages = pendingChanges[pdf.name]?.ignore_pages || pdf.ignore_pages || [];
        totalIgnored += ignorePages.length;
    });
    
    document.getElementById('totalIgnoredPages').textContent = totalIgnored;
    // Azure S0 Read: $1.50 per 1,000 pages = $0.0015 per page
    const savings = (totalIgnored * 0.0015).toFixed(3);
    document.getElementById('estimatedSavings').textContent = `$${savings}`;
}

function updatePageCountInfo() {
    if (!selectedPdf) {
        document.getElementById('pageCountInfo').textContent = '';
        return;
    }
    const ignorePages = pendingChanges[selectedPdf.name]?.ignore_pages || selectedPdf.ignore_pages || [];
    const total = selectedPdf.total_pages || 0;
    const kept = total - ignorePages.length;
    document.getElementById('pageCountInfo').textContent = `${total} pages | ${kept} keep | ${ignorePages.length} ignore`;
}

async function selectPdf(name) {
    selectedPdf = allPdfs.find(p => p.name === name);
    if (!selectedPdf) return;
    
    document.getElementById('viewerTitle').textContent = name.substring(0, 40) + (name.length > 40 ? '...' : '');
    
    // Load notes
    const notes = pendingChanges[name]?.notes ?? selectedPdf.notes ?? '';
    document.getElementById('notesInput').value = notes;
    
    // Show loading
    document.getElementById('pdfPagesContainer').innerHTML = `
        <div class="text-slate-400 text-center py-20">
            <div class="text-4xl mb-4 animate-pulse">‚è≥</div>
            <div>Loading PDF pages...</div>
        </div>
    `;
    
    // Load PDF and render all pages
    await loadPdfAndRenderAllPages(name);
    
    renderPdfList();
    updatePageCountInfo();
}

async function loadPdfAndRenderAllPages(name) {
    const mode = getMode();
    renderedCanvases = {}; // Clear cache
    
    try {
        const url = `/api/pdf/${encodeURIComponent(name)}?mode=${mode}`;
        pdfDoc = await pdfjsLib.getDocument(url).promise;
        selectedPdf.total_pages = pdfDoc.numPages;
        
        // Render all pages
        await renderAllPages();
        
    } catch (e) {
        console.error('Error loading PDF:', e);
        document.getElementById('pdfPagesContainer').innerHTML = `
            <div class="text-red-400 text-center py-20">
                <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                <div>Error loading PDF</div>
                <div class="text-sm">${e.message}</div>
            </div>
        `;
    }
}

async function renderAllPages() {
    if (!pdfDoc || !selectedPdf) return;
    
    const container = document.getElementById('pdfPagesContainer');
    const ignorePages = pendingChanges[selectedPdf.name]?.ignore_pages || selectedPdf.ignore_pages || [];
    
    // Create grid container with dynamic columns
    const gridClass = `grid gap-3 grid-cols-${columnCount}`;
    container.innerHTML = `<div id="pagesGrid" class="${gridClass}"></div>`;
    const grid = document.getElementById('pagesGrid');
    
    // Render each page
    for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
        const isIgnored = ignorePages.includes(pageNum);
        
        // Create page wrapper
        const pageWrapper = document.createElement('div');
        pageWrapper.id = `page-wrapper-${pageNum}`;
        pageWrapper.className = `relative cursor-pointer rounded-lg overflow-hidden transition-all duration-200 ${isIgnored ? 'ring-4 ring-red-500' : 'ring-4 ring-green-500'} hover:ring-pink-400 hover:scale-105`;
        pageWrapper.onclick = () => togglePage(pageNum);
        pageWrapper.title = `Page ${pageNum} - Click to ${isIgnored ? 'KEEP' : 'IGNORE'}`;
        
        // Page number badge
        const badge = document.createElement('div');
        badge.className = `absolute top-1 left-1 px-2 py-1 rounded text-xs font-bold z-10 ${isIgnored ? 'bg-red-600' : 'bg-green-600'}`;
        badge.textContent = pageNum;
        pageWrapper.appendChild(badge);
        
        // Status label
        const statusLabel = document.createElement('div');
        statusLabel.className = `absolute top-1 right-1 px-2 py-1 rounded text-xs font-bold z-10 ${isIgnored ? 'bg-red-600' : 'bg-green-600'}`;
        statusLabel.textContent = isIgnored ? 'üö´' : '‚úÖ';
        pageWrapper.appendChild(statusLabel);
        
        // Canvas placeholder
        const canvasContainer = document.createElement('div');
        canvasContainer.className = 'bg-white';
        canvasContainer.id = `canvas-container-${pageNum}`;
        pageWrapper.appendChild(canvasContainer);
        
        // Overlay for ignored pages
        if (isIgnored) {
            const overlay = document.createElement('div');
            overlay.className = 'absolute inset-0 bg-red-500 bg-opacity-40 flex items-center justify-center';
            overlay.innerHTML = '<span class="text-white font-bold text-lg bg-red-600 px-3 py-1 rounded">IGNORE</span>';
            pageWrapper.appendChild(overlay);
        }
        
        grid.appendChild(pageWrapper);
        
        // Render page asynchronously
        renderSinglePage(pageNum, canvasContainer);
    }
    
    updatePageCountInfo();
}

async function renderSinglePage(pageNum, container) {
    try {
        const page = await pdfDoc.getPage(pageNum);
        
        // Use higher scale for better quality, then scale down with CSS
        const renderScale = Math.max(zoomScale * 2, 1.0); // Minimum 1.0 for clarity
        const viewport = page.getViewport({ scale: renderScale });
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size to high resolution
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        
        // Display size controlled by CSS (scaled down for layout)
        const displayWidth = viewport.width * (zoomScale / renderScale);
        canvas.style.width = displayWidth + 'px';
        canvas.style.height = 'auto';
        canvas.className = 'w-full h-auto';
        
        // Enable image smoothing for better quality
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        
        await page.render({ canvasContext: ctx, viewport }).promise;
        
        container.innerHTML = '';
        container.appendChild(canvas);
        
        // Cache it
        renderedCanvases[pageNum] = canvas;
        
    } catch (e) {
        container.innerHTML = `<div class="p-4 text-red-400 text-xs">Error</div>`;
    }
}

function togglePage(pageNum) {
    if (!selectedPdf) return;
    
    // Initialize pending changes if needed
    if (!pendingChanges[selectedPdf.name]) {
        pendingChanges[selectedPdf.name] = {
            ignore_pages: [...(selectedPdf.ignore_pages || [])],
            total_pages: selectedPdf.total_pages,
            notes: selectedPdf.notes || ''
        };
    }
    
    const ignorePages = pendingChanges[selectedPdf.name].ignore_pages;
    const idx = ignorePages.indexOf(pageNum);
    
    if (idx === -1) {
        ignorePages.push(pageNum);
    } else {
        ignorePages.splice(idx, 1);
    }
    
    // Update just this page's visual state
    updatePageVisual(pageNum);
    renderPdfList();
    updateStats();
    updatePageCountInfo();
}

function updatePageVisual(pageNum) {
    const ignorePages = pendingChanges[selectedPdf.name]?.ignore_pages || selectedPdf.ignore_pages || [];
    const isIgnored = ignorePages.includes(pageNum);
    
    const wrapper = document.getElementById(`page-wrapper-${pageNum}`);
    if (!wrapper) return;
    
    // Update ring color
    wrapper.className = `relative cursor-pointer rounded-lg overflow-hidden transition-all duration-200 ${isIgnored ? 'ring-4 ring-red-500' : 'ring-4 ring-green-500'} hover:ring-pink-400 hover:scale-105`;
    wrapper.title = `Page ${pageNum} - Click to ${isIgnored ? 'KEEP' : 'IGNORE'}`;
    
    // Update badge
    const badge = wrapper.querySelector('div:first-child');
    if (badge) {
        badge.className = `absolute top-1 left-1 px-2 py-1 rounded text-xs font-bold z-10 ${isIgnored ? 'bg-red-600' : 'bg-green-600'}`;
    }
    
    // Update status label
    const statusLabel = wrapper.querySelectorAll('div')[1];
    if (statusLabel) {
        statusLabel.className = `absolute top-1 right-1 px-2 py-1 rounded text-xs font-bold z-10 ${isIgnored ? 'bg-red-600' : 'bg-green-600'}`;
        statusLabel.textContent = isIgnored ? 'üö´' : '‚úÖ';
    }
    
    // Update or add/remove overlay
    let overlay = wrapper.querySelector('.bg-red-500');
    if (isIgnored && !overlay) {
        overlay = document.createElement('div');
        overlay.className = 'absolute inset-0 bg-red-500 bg-opacity-40 flex items-center justify-center';
        overlay.innerHTML = '<span class="text-white font-bold text-lg bg-red-600 px-3 py-1 rounded">IGNORE</span>';
        wrapper.appendChild(overlay);
    } else if (!isIgnored && overlay) {
        overlay.remove();
    }
}

function zoomIn() {
    zoomScale = Math.min(zoomScale + 0.05, 1.5);
    document.getElementById('zoomLevel').textContent = Math.round(zoomScale * 100) + '%';
    if (pdfDoc) renderAllPages();
}

function zoomOut() {
    zoomScale = Math.max(zoomScale - 0.05, 0.1);
    document.getElementById('zoomLevel').textContent = Math.round(zoomScale * 100) + '%';
    if (pdfDoc) renderAllPages();
}

function setColumns(cols) {
    columnCount = cols;
    // Update button styles
    for (let i = 1; i <= 6; i++) {
        const btn = document.getElementById(`col-${i}`);
        if (btn) {
            if (i === cols) {
                btn.className = 'px-2 py-1 bg-pink-600 rounded text-xs';
            } else {
                btn.className = 'px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs';
            }
        }
    }
    // Re-render if PDF is loaded
    if (pdfDoc) renderAllPages();
}

function updateColumnButtons() {
    for (let i = 1; i <= 6; i++) {
        const btn = document.getElementById(`col-${i}`);
        if (btn) {
            if (i === columnCount) {
                btn.className = 'px-2 py-1 bg-pink-600 rounded text-xs';
            } else {
                btn.className = 'px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs';
            }
        }
    }
}

function selectAllPages() {
    if (!selectedPdf || !selectedPdf.total_pages) return;
    
    if (!pendingChanges[selectedPdf.name]) {
        pendingChanges[selectedPdf.name] = {
            ignore_pages: [],
            total_pages: selectedPdf.total_pages,
            notes: selectedPdf.notes || ''
        };
    }
    
    pendingChanges[selectedPdf.name].ignore_pages = Array.from({length: selectedPdf.total_pages}, (_, i) => i + 1);
    
    // Update all visuals
    for (let i = 1; i <= selectedPdf.total_pages; i++) {
        updatePageVisual(i);
    }
    renderPdfList();
    updateStats();
    updatePageCountInfo();
}

function deselectAllPages() {
    if (!selectedPdf) return;
    
    if (!pendingChanges[selectedPdf.name]) {
        pendingChanges[selectedPdf.name] = {
            ignore_pages: [],
            total_pages: selectedPdf.total_pages,
            notes: selectedPdf.notes || ''
        };
    }
    
    pendingChanges[selectedPdf.name].ignore_pages = [];
    
    // Update all visuals
    for (let i = 1; i <= selectedPdf.total_pages; i++) {
        updatePageVisual(i);
    }
    renderPdfList();
    updateStats();
    updatePageCountInfo();
}

function invertSelection() {
    if (!selectedPdf || !selectedPdf.total_pages) return;
    
    if (!pendingChanges[selectedPdf.name]) {
        pendingChanges[selectedPdf.name] = {
            ignore_pages: [...(selectedPdf.ignore_pages || [])],
            total_pages: selectedPdf.total_pages,
            notes: selectedPdf.notes || ''
        };
    }
    
    const current = new Set(pendingChanges[selectedPdf.name].ignore_pages);
    const inverted = [];
    for (let i = 1; i <= selectedPdf.total_pages; i++) {
        if (!current.has(i)) inverted.push(i);
    }
    
    pendingChanges[selectedPdf.name].ignore_pages = inverted;
    
    // Update all visuals
    for (let i = 1; i <= selectedPdf.total_pages; i++) {
        updatePageVisual(i);
    }
    renderPdfList();
    updateStats();
    updatePageCountInfo();
}

async function saveAllChanges() {
    const mode = getMode();
    const updates = [];
    
    // Collect all pending changes
    for (const [pdfName, changes] of Object.entries(pendingChanges)) {
        updates.push({
            pdf_name: pdfName,
            ignore_pages: changes.ignore_pages,
            total_pages: changes.total_pages,
            notes: changes.notes
        });
    }
    
    // Also save current notes if changed
    if (selectedPdf) {
        const currentNotes = document.getElementById('notesInput').value;
        if (!pendingChanges[selectedPdf.name]) {
            if (currentNotes !== (selectedPdf.notes || '')) {
                updates.push({
                    pdf_name: selectedPdf.name,
                    ignore_pages: selectedPdf.ignore_pages || [],
                    total_pages: selectedPdf.total_pages,
                    notes: currentNotes
                });
            }
        } else {
            pendingChanges[selectedPdf.name].notes = currentNotes;
            const entry = updates.find(u => u.pdf_name === selectedPdf.name);
            if (entry) entry.notes = currentNotes;
        }
    }
    
    if (updates.length === 0) {
        alert('No changes to save');
        return;
    }
    
    try {
        const response = await fetch(`/api/human-loop/batch-update?mode=${mode}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        const result = await response.json();
        if (result.success) {
            alert(`Saved ${result.updated_count} document(s) successfully!`);
            pendingChanges = {};
            await loadPdfList();
            if (selectedPdf) {
                // Refresh selected PDF data
                selectedPdf = allPdfs.find(p => p.name === selectedPdf.name);
                updatePageCountInfo();
            }
        } else {
            alert('Error saving: ' + (result.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Error saving: ' + e.message);
    }
}

function refreshList() {
    if (Object.keys(pendingChanges).length > 0) {
        if (!confirm('You have unsaved changes. Discard them?')) return;
    }
    pendingChanges = {};
    loadPdfList();
}

function onModeChange() {
    pendingChanges = {};
    selectedPdf = null;
    pdfDoc = null;
    renderedCanvases = {};
    document.getElementById('pdfPagesContainer').innerHTML = `
        <div class="text-slate-500 text-center py-20">
            <div class="text-6xl mb-4">üìÑ</div>
            <div class="text-lg">Select a PDF from the list</div>
            <div class="text-sm mt-2">Click on any page to toggle ignore/keep</div>
        </div>
    `;
    document.getElementById('viewerTitle').textContent = 'Select a PDF';
    document.getElementById('pageCountInfo').textContent = '';
    loadPdfList();
}

// Initialize
loadPdfList();
document.getElementById('zoomLevel').textContent = Math.round(zoomScale * 100) + '%';
updateColumnButtons();
</script>
{% endblock %}
